---
title: Movebank Results
output: 
  github_document:
    df_print: kable
author: Alec Robitaille
date: "`r Sys.Date()`"
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(echo = TRUE,
											eval = TRUE)
```




```{r pkgs}
# Packages ----------------------------------------------------------------
library(data.table)
library(taxize)
library(ggplot2)
library(patchwork)
```

```{r data}
# Data --------------------------------------------------------------------
details <- fread('data-sources/details.csv')
taxes <- fread('data-sources/taxes.csv')
DT <- fread('data-sources/taxed-details.csv')
```


`taxon_ids` column

```{r checkids}
details[, .N, .(is.na(taxon_ids), taxon_ids == '')]
```


Out of `r details[taxon_ids == '', .N]` rows with seemingly valid `taxon_ids`, there are up to 17 species listed in any row. Eg. 


```{r eglong}
details[id == 422952928]$taxon_ids
```

Grabbing the family and class, then combining the taxonomies with the study details dataset, we have `r DT[, .N]` species by study rows. 


TODO: N access, family, class, access by taxonomy etc

```{r class, fig.width = 9}
DT[, .N, class]

ggplot(DT) + 
	geom_bar(aes(class, fill = i_have_download_access)) +
	guides(fill = FALSE)
```


Careful double counting, because the `DT` dataset now has duplicated study rows for each parsed taxon. 

```{r unique}
# Grab the unique rows based on study id
countDT <- unique(DT, by = 'id')
```


# *Mammalia*

Just exploring mammals, the following figures show download access TRUE in blue, 
and FALSE in red. **Note: counts are log scaled**. 

## Number of studies by family

```{r studies, fig.height=9}
ggplot(countDT[class == 'Mammalia']) + 
	geom_bar(aes(factor(family, sort(unique(family), TRUE)),
							 fill = i_have_download_access)) +
	coord_flip() +
	scale_y_log10() +
	labs(y = 'Number of studies', x = 'Family') +
	guides(fill = FALSE)
```


## Number of individuals by family
```{r numbids, fig.height=9}
ggplot(countDT[class == 'Mammalia', sum(number_of_individuals, na.rm = TRUE), .(i_have_download_access, family)]) + 
	geom_col(aes(factor(family, sort(unique(family), TRUE)),
							 V1,
							 fill = i_have_download_access)) +
  scale_y_log10() +
	coord_flip() +
	labs(y = 'Number of individuals', x = 'Family')  +
	guides(fill = FALSE)
```

## Number of relocations by family
```{r numblobs, fig.height=9}
ggplot(countDT[class == 'Mammalia', sum(number_of_deployed_locations, na.rm = TRUE), .(i_have_download_access, family)]) + 
	geom_col(aes(factor(family, sort(unique(family), TRUE)),
							 V1,
							 fill = i_have_download_access)) +
	scale_y_log10() +
	coord_flip() +
	labs(y = 'Number of relocations', x = 'Family') +
	guides(fill = FALSE)
```


```{r}
countDT[, .(N = sum(number_of_deployed_locations), family = family[[1]], class = class[[1]],
						i_have_download_access = i_have_download_access[[1]]), 
				by = matched_name][order(-N, class)][, .SD[1:3], by = class]
```

Some elements of the database are strange. How do these datasets have last deployed
timestamps in the 10-25 year future?

```{r}
DT[matched_name == 'Polemaetus bellicosus'][, .(
	matched_name,
	family,
	class,
	sensor_type_ids,
	timestamp_first_deployed_location,
	timestamp_last_deployed_location,
	number_of_deployed_locations
)]
```
